import boto3
import datetime
import json
from decimal import Decimal
from boto3.dynamodb.conditions import Attr

# Initialize clients
dynamodb = boto3.resource('dynamodb', region_name='us-east-1')
sns = boto3.client('sns')

# Replace with your actual table name and SNS topic ARN
TABLE_NAME = 'receipt_data'
SNS_TOPIC_ARN = 'arn:aws:sns:us-east-1:614520203147:weekly-receipt-summary'

def lambda_handler(event, context):
    print("Active region:", boto3.session.Session().region_name)
    print("Available tables:")
    for t in dynamodb.tables.all():
        print(" -", t.name)
    
    table = dynamodb.Table(TABLE_NAME)
    
    # Define the start of the 7-day period
    now = datetime.datetime.utcnow()
    start_date = now - datetime.timedelta(days=7)
    start_date_str = start_date.strftime('%Y-%m-%d')

    # Scan with a filter expression for the last 7 days
    items = []
    scan_kwargs = {
        'FilterExpression': Attr('date').gte(start_date_str)
    }

    # Handle pagination
    while True:
        response = table.scan(**scan_kwargs)
        items.extend(response['Items'])
        if 'LastEvaluatedKey' not in response:
            break
        scan_kwargs['ExclusiveStartKey'] = response['LastEvaluatedKey']

    # Categorize totals
    summary = {}
    for receipt in items:
        category = receipt.get('category', 'Other')
        amount = Decimal(receipt.get('total', 0))
        summary[category] = summary.get(category, 0) + amount

    # Format message
    message = "ðŸ§¾ Weekly Spending Summary\n\n"
    if summary:
        for cat, amt in sorted(summary.items()):
            message += f"- {cat}: ${float(amt):.2f}\n"
    else:
        message += "No receipts found for this week.\n"
    
    total_spent = sum(summary.values())
    message += f"\nTotal Spent: ${float(total_spent):.2f}"
    message += f"\nTotal Receipts: {len(items)}"

    # Publish to SNS
    sns.publish(
        TopicArn=SNS_TOPIC_ARN,
        Subject="Weekly Receipt Report",
        Message=message
    )

    return {
        "statusCode": 200,
        "body": json.dumps({
            "status": "Report sent",
            "receipt_count": len(items),
            "total_spent": float(total_spent)
        })
    }
